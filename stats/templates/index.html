<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  {% load static %}
  {% load humanize %}
  {% load mathfilters %}
  {% load stat_extras %}

  <title>{{ guild.name }} Stats</title>

  <link rel="stylesheet" href="{% static 'style.css' %}" type="text/css" />
  <link rel="stylesheet" href="{% static 'js/tablesorter/css/theme.custom.min.css' %}" type="text/css" />
  <link rel="icon" href="{{ guild.icon }}">

  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
  <script type="text/javascript" src="{% static 'js/tablesorter/js/jquery.tablesorter.min.js' %}"></script>
  <script type="text/javascript" src="{% static 'js/tablesort_setup.js' %}"></script>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  {{ date_data|json_script:"dateData" }}
</head>

<body>
  <center>
    <h1>
      {{ guild.name }} Stats (rendered on {% now "n/j/o" %})
    </h1>
    <span class="subtext">
      Statistics generated from {{ first_message_date|date:"l n/j/o" }} to {{ last_message_date|date:"l n/j/o" }}
    </span>
    <br>
    <span class="subtext">
      {{ total_users|intcomma }} different users sent a total of {{ total_messages|intcomma }} messages in this server during this {{ total_days|intcomma }}-day reporting period
    </span>
    <br>
    <br>
    <div class="headerlinks">
    1. Main page | <a href="details/">2. Detailed info</a> | <a href="FAQ/">3. FAQ</a>
    </div>

    <div class="greybar"></div>


    <!-- 
      When's the best time to chat?
    -->

    <h3>When's the best time to chat?</h3>
    <table cellspacing="1" cellpadding="2">
      <tbody>
        <tr class="hour_percentage" valign="bottom">
          {% for hour, value in total_hour_counts.items %}
            <td class="tgr">
              <!-- hour percentage value -->
              {{ value|div:total_messages|mul:100|floatformat:1 }}%
              <br>
              <!-- changes color of bar based on time of day -->
              <div class='{{ hour|set_hour_class }}' style="width:18px; height:{% widthratio value max_hour_count 120 %}px;">
            </td>
          {% endfor %}
        </tr>

        <!-- lists out every hour from 12AM to 11PM -->
        <tr class="s3">
          {% for hourstr in hour_strings %}
            <td class="cd">{{ hourstr }}</td>
          {% endfor %}
        </tr>
      </tbody>
    </table>
    <br>
    <span class="subtext">PST / PDT (UTC-8/7)</span>
    <br>
    <br>
    <table border="0" class="txt1">
      <tbody>
        <tr>
          <td class="tinv">
            <div class="bluebar keybar" title="12AM-5AM"></div>
            Night
          </td>
          <td class="tinv" width="20"></td>
          <td class="tinv">
            <div class="greenbar keybar" title="6AM-11AM"></div>
            Morning
          </td>
          <td class="tinv" width="20"></td>
          <td class="tinv">
            <div class="yellowbar keybar" title="12PM-5PM"></div>
            Afternoon
          </td>
          <td class="tinv" width="20"></td>
          <td class="tinv">
            <div class="redbar keybar" title="6PM-11PM"></div>
            Evening
          </td>
        </tr>
      </tbody>
    </table>

    <div class="greybar"></div>

    <!-- 
      Day-by-day server load
    -->
    <h3>Day-by-day server load</h3>
    <br>
    <div style="width: 50%; margin-left: 8.7%;">
      <button class="subtext selectedTablink" onclick="openPage('topWeekly', this)">Weekly</button>
      <button class="subtext tablink" onclick="openPage('topMonthly', this)">Monthly</button>
      <button class="subtext tablink" onclick="openPage('topYearly', this)">Yearly</button>
      <button class="subtext tablink" onclick="openPage('topAllTime', this)">All Time</button>
    </div>
    <br><br>
    <div id="topWeekly" class="tabcontent"></div>
    <div id="topMonthly" class="tabcontent"></div>
    <div id="topYearly" class="tabcontent"></div>
    <div id="topAllTime" class="tabcontent"></div>


    <div class="greybar"></div>
    <!-- 
      100 Most Talkative Users
    -->
    <h3>100 Most Talkative Users</h3>
    <table border="0" cellspacing="1" cellpadding="2" 
    class="tablesorter default_table" id="user_rankings">
      <tbody>
        <thead>
          <!-- tablesort settings for each column defined here-->
          <th data-sorter="false"></th>
          <th data-sorter="false">Nick</th>
          <th data-lockedorder="desc" class="sorter-bignumber">Line Count</th>
          <th data-lockedorder="desc">Lines Per Day</th>
          <th data-sorter="false">Peculiar Words</th>
          <th data-sorter="false">Favorite Emojis</th>
        </thead>
        {% for user_dict in user_messages_table %}
          <tr>
            <td class="rank">
              {{ forloop.counter }}
            </td>
            <td class="nick">
              <img src="{{ user_dict.user.avatar }}" class="icon">
              &nbsp;
              <a href="/stats/users/{{ user_dict.user.tag }}" class="userlink">{{ user_dict.user.nick }}</a>
            </td>

            <td class="line_count">
              <div class="bluebar" style="height:15px; width: {% widthratio user_dict.time_of_day_counts.night most_messages 100 %}px"></div>
              <div class="greenbar" style="height:15px; width: {% widthratio user_dict.time_of_day_counts.morning most_messages 100 %}px"></div>
              <div class="yellowbar" style="height:15px; width: {% widthratio user_dict.time_of_day_counts.afternoon most_messages 100 %}px"></div>
              <div class="redbar" style="height:15px; width: {% widthratio user_dict.time_of_day_counts.evening most_messages 100 %}px; margin-right:3px;"></div>
              {{ user_dict.user.messages|intcomma }}
            </td>

            <td>
              {{ user_dict.lines_per_day|floatformat:1 }}
            </td>

            <td class="words">
              {{ user_dict.special_words|join:", " }}
            </td>

            <td>
              <font size="+1">
                {% for emoji in user_dict.emojis %}
                  {% if emoji.custom %}
                    <img src="{{ emoji.custom_emoji }}" height="15">
                  {% else %}
                    {{ emoji.default_emoji }}
                  {% endif %}
                {% endfor %}
              </font>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="greybar"></div>

    <!-- 
      Time of Day Stats
    -->
    <h3>Time of day stats</h3>
    <table cellspacing="1" cellpadding="2" class="default_table tiny_table" id="time_of_day">
      <thead>
        <th></th>
        <th>Nightcrawlers<br> <span class="hours">(12AM - 6AM)</span></th>
        <th>Early Birds<br> <span class="hours">(6AM - 12PM)</span></th>
        <th>Afternoon Shift<br> <span class="hours">(12PM - 6PM)</span></th>
        <th>Evening chatters<br> <span class="hours">(6PM - 12AM)</span></th>
      </thead>
      <tbody>
        {% for zip_packet in time_of_day_table %}
          <tr>
            <td>{{ forloop.counter }} </td>
            {% for user, count in zip_packet %}
              <td>
                <a href="/stats/users/{{ user.tag }}" class="userlink">{{ user.nick }}</a> - {{ count }}
                <br>
                {% cycle 'bluebar' 'greenbar' 'yellowbar' 'redbar' as bar_class silent %}
                {% cycle time_of_day_maxes.0 time_of_day_maxes.1 time_of_day_maxes.2 time_of_day_maxes.3 as current_time_most_messages silent %}
                <img class="icon mini_icon" src="{{ user.avatar }}"><!--
                --><div class="{{ bar_class }} time_of_day_bar" style="height:5px; width:{% widthratio count current_time_most_messages 100 %}px;"></div>
              </td>
            {% endfor %}
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </center>
  <script type="text/javascript" src="{% static 'js/chart_setup.js' %}"></script>
</body>
</html>